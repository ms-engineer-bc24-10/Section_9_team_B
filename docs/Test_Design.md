# テスト設計書: ひろいっぽ

## 概要

「ひろいっぽ」のテスト設計書です。この設計書は、各機能が正しく動作するかを確認するためのものです。

---

## 認証機能（ユーザー名バリデーション）

### 1. 単体テスト（Unit Test）

#### テスト対象関数

`validateUsername`

#### テストケース

##### 1.1 有効なユーザー名

| テストケース         | 入力値          | 期待結果 |
| -------------------- | --------------- | -------- |
| 英数字のみ           | "user123"       | true     |
| アンダースコアを含む | "user_name"     | true     |
| 日本語（ひらがな）   | "ゆーざー"      | true     |
| 日本語（カタカナ）   | "ユーザー"      | true     |
| 日本語（漢字）       | "太郎"          | true     |
| 混合                 | "user123\_太郎" | true     |

##### 1.2 無効なユーザー名

| テストケース   | 入力値           | 期待結果 |
| -------------- | ---------------- | -------- |
| 空文字列       | ""               | false    |
| スペースを含む | "user name"      | false    |
| 特殊文字を含む | "user@name"      | false    |
| 絵文字を含む   | "user😊"         | false    |
| 全角英数字     | "ｕｓｅｒ１２３" | false    |

### 2. 統合テスト（Integration Test）

#### テスト対象

signup/page コンポーネント

#### テストケース

##### 2.1 有効なユーザー名でフォーム送信

- 手順:
  1. 有効なユーザー名を入力
  2. その他の必要なフィールドに有効な値を入力
  3. フォームを送信
- 期待結果: エラーメッセージが表示されない

##### 2.2 無効なユーザー名でフォーム送信

- 手順:
  1. 無効なユーザー名を入力
  2. その他の必要なフィールドに有効な値を入力
  3. フォームを送信
- 期待結果: "ユーザー名は英数字、アンダースコア、日本語文字のみ使用できます。" というエラーメッセージが表示される

##### 2.3 ユーザー名入力フィールドの動作確認

- テスト項目:
  - 入力: 文字が正しく入力されるか
  - 削除: バックスペースや Delete キーで文字を削除できるか
  - コピー&ペースト: テキストのコピーとペーストが正常に機能するか
- 期待結果: すべての操作が正常に機能する

### テスト実行環境

- テストフレームワーク: Jest
- テストライブラリ: React Testing Library

### テストファイル

1. 単体テスト: `validation.test.ts`
2. 統合テスト: `page.test.tsx`

### テスト実行コマンド

```
npm test
```

---

## 画像解析機能

### 1. 概要

Google Vision API を利用した画像解析関数 `analyze_garbage` が、以下の要件を満たして正しく動作するかを確認します。

- ゴミ袋および関連オブジェクトの検出
- ラベル情報の取得
- ゴミ袋の面積とポイントの算出

### 2. テスト対象

#### 対象モジュール

- `garbage_analysis.google_vision`

#### 対象関数

- `analyze_garbage(image_path: str) -> dict`

---

### 3. テスト目的

1. 関数が正確にゴミ袋や関連するラベルを検出することを確認します。
2. 面積とポイントが正しく算出されることを確認します。
3. 異常系の入力に対して適切なエラー処理が行われることを確認します。

---

### 4. 前提条件

- Google Vision API の認証情報が正しく設定されていること。
- モックを使用してテストが外部依存なしで実行可能であること。
- テスト環境に必要なモジュール（`unittest`, `unittest.mock` など）がインストールされていること。

---

### 5. テスト項目

| **テスト ID** | **テスト内容**                                                             | **期待結果**                       |
| ------------- | -------------------------------------------------------------------------- | ---------------------------------- |
| T001          | ゴミ袋（`plastic bag`）が適切に検出されるか確認                            | `garbage_bag_detected=True`        |
| T002          | 検出されたラベルに `plastic bag` と `bottle` が含まれるか確認              | `labels=['plastic bag', 'bottle']` |
| T003          | ゴミ袋の面積が計算され、その結果に基づいてポイントが適切に算出されるか確認 | 面積が計算され、`points > 0`       |

---

### 6. テスト手順

1. **モックの設定**:

   - `open` 関数をモックして、画像データ（`b"dummy image data"`）を返すように設定します。
   - `ImageAnnotatorClient` をモックして、以下のレスポンスを返すように設定します。
     - ラベル: `plastic bag` と `bottle`
     - オブジェクト: `bag`

2. **関数の実行**:

   - 関数 `analyze_garbage` をダミーパス（`"dummy_path"`）で実行します。

3. **結果の検証**:
   - `garbage_bag_detected` が `True` であることを確認します。
   - ラベルリストに `plastic bag` と `bottle` が含まれることを確認します。
   - 算出されたポイントが 0 より大きいことを確認します。

---

### 7. テストデータ

| **テストデータ** | **内容**                                                                                     |
| ---------------- | -------------------------------------------------------------------------------------------- |
| `dummy_path`     | ファイルパスの代わりに使用するダミーデータ（`open`関数のモックにより、実際のファイルは不要） |

---

## 決済機能

### 概要

本設計書は、Django を用いた決済機能および Stripe 連携のテストを行うためのものです。以下のエンドポイントを対象とします。

- `create_subscription`: サブスクリプションセッションの作成
- `create_one_time_payment`: 都度払いセッションの作成
- `stripe_webhook`: Stripe Webhook の処理

各機能について、ユニットテストと統合テストを設計します。

---

### 対象機能

#### 1. `create_subscription`

- **目的**: サブスクリプション用の Stripe セッションを正しく作成できるか確認する。
- **入力**:
  - `POST`リクエスト
  - `user_id` (必須)
- **期待される出力**:
  - 成功時: セッション URL (`url`) を含む JSON レスポンスを返す。
  - 失敗時: エラーレスポンスを返す。

##### テストケース

| テスト ID | テスト内容                     | 入力データ                          | 期待される結果         |
| --------- | ------------------------------ | ----------------------------------- | ---------------------- |
| TCS1-01   | 正常なリクエスト               | `user_id`: "12345"                  | セッション URL を返す  |
| TCS1-02   | `user_id`が空                  | `user_id`: 空                       | 400 エラーを返す       |
| TCS1-03   | リクエストメソッドが`POST`以外 | `GET`リクエスト                     | 405 エラーを返す       |
| TCS1-04   | Stripe API エラー              | Stripe API をモックしてエラーを発生 | エラーレスポンスを返す |

---

#### 2. `create_one_time_payment`

- **目的**: 都度払い用の Stripe セッションを正しく作成できるか確認する。
- **入力**:
  - `POST`リクエスト
  - `user_id` (必須)
  - `reservation_date` (必須)
  - `is_participating` (任意)
- **期待される出力**:
  - 成功時: セッション URL (`url`) を含む JSON レスポンスを返す。
  - 失敗時: エラーレスポンスを返す。

##### テストケース

| テスト ID | テスト内容                           | 入力データ                                           | 期待される結果         |
| --------- | ------------------------------------ | ---------------------------------------------------- | ---------------------- |
| TCS2-01   | 正常なリクエスト                     | `user_id`: "12345", `reservation_date`: "2024-12-31" | セッション URL を返す  |
| TCS2-02   | `user_id`が空                        | `user_id`: 空                                        | 400 エラーを返す       |
| TCS2-03   | `reservation_date`が空               | `reservation_date`: 空                               | 400 エラーを返す       |
| TCS2-04   | リクエストメソッドが`POST`以外       | `GET`リクエスト                                      | 405 エラーを返す       |
| TCS2-05   | Stripe API エラー                    | Stripe API をモックしてエラーを発生                  | エラーレスポンスを返す |
| TCS2-06   | `is_participating`が指定されない場合 | `user_id`: "12345", `reservation_date`: "2024-12-31" | セッション URL を返す  |

---

#### 3. `stripe_webhook`

- **目的**: Stripe Webhook の受信イベントを正しく処理し、データベースに取引を登録できるか確認する。
- **入力**:
  - Webhook リクエスト
  - `checkout.session.completed`イベント
- **期待される出力**:
  - 成功時: HTTP 200 を返す。
  - 失敗時: HTTP 400 または 500 を返す。

##### テストケース

| テスト ID | テスト内容                      | 入力データ                                 | 期待される結果                    |
| --------- | ------------------------------- | ------------------------------------------ | --------------------------------- |
| TCS3-01   | 正常な Webhook イベント         | 正常な`checkout.session.completed`イベント | HTTP 200 を返す                   |
| TCS3-02   | 不正なペイロード                | 不正なリクエストボディ                     | HTTP 400 を返す                   |
| TCS3-03   | 署名検証エラー                  | 不正な署名ヘッダー                         | HTTP 400 を返す                   |
| TCS3-04   | データベース登録失敗            | 重複する `stripe_session_id`               | HTTP 500 を返し、エラーを記録する |
| TCS3-05   | 未対応の Webhook イベントを受信 | 未対応のイベント                           | HTTP 200 を返す（ログのみ記録）   |
| TCS3-06   | 支払い失敗イベント              | `invoice.payment_failed`イベント           | HTTP 200 を返す（ログのみ記録）   |

---

### テスト環境

- **フレームワーク**: `pytest` + `pytest-django`
  - Django 設定でインメモリ SQLite を利用するように構成。
- **Stripe モックツール**: `stripe-mock` を利用
- **データベース**: インメモリ SQLite データベース（テスト終了時に自動破棄）
- **カバレッジ測定**:
  ツール: pytest-cov を使用。
  目標: ステートメントカバレッジ 85%以上。
  実行例:
  ```
  pytest --cov=your_project_directory --cov-report=term-missing
  ```
  実行されなかったコード行を表示し、カバレッジを確認。
  必要に応じて HTML レポートを生成:
  ```
  pytest --cov=your_project_directory --cov-report=html
  ```

---

### 実施手順

1. **Django 設定の変更**

   - テスト環境でインメモリ SQLite を使用するように設定します。
     ```python
     DATABASES = {
         "default": {
             "ENGINE": "django.db.backends.sqlite3",
             "NAME": ":memory:",
         }
     }
     ```

2. **Stripe API のモック**

   - `stripe-mock` を使用して、模擬的な Stripe API を構築。

3. **ユニットテストの実行**

   - 入力値のバリデーションやレスポンスの形式を検証します。
   - データベースエラーが発生しないケースを中心に検証します。

4. **統合テストの実行**

   - インメモリ SQLite を利用し、データベースとの連携を含む一連の処理を検証します。
   - 特に、以下のケースを重点的にテストします：
     - `TCS3-01`: 正常な Webhook イベントでデータベース登録。
     - `TCS3-04`: ユニーク制約違反で登録失敗。

5. テストカバレッジの確認
   - コマンドを使用して測定結果を取得し、目標カバレッジを満たしているか確認します。
   ```
     pytest payments/tests/ --cov=payments --cov-report=term-missing
   ```
